<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lost & Found — Portal</title>

<style>
  :root{
    --bg:#f4f7fb;
    --card:#ffffff;
    --accent:#7c3aed;
    --accent-2:#5b21b6;
    --muted:#6b7280;
    --success:#10b981;
    --danger:#ef4444;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background: linear-gradient(180deg,#f6f9ff 0,#fbfdff 100%);
    color:#0f172a;
    -webkit-font-smoothing:antialiased;
  }

  header{
    background: linear-gradient(90deg,var(--accent),var(--accent-2));
    color:white;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;
  }
  header h1{font-size:18px;margin:0;font-weight:700}
  header .user{font-size:13px;opacity:.95}

  .main{max-width:1100px;margin:26px auto;padding:18px;display:grid;grid-template-columns:360px 1fr;gap:22px}
  @media (max-width:960px){ .main{grid-template-columns:1fr;padding:12px} }

  /* left column card */
  .panel{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 8px 30px rgba(15,23,42,0.06)}
  .panel h2{margin:0 0 8px 0;font-size:16px}
  .muted{color:var(--muted);font-size:13px}

  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 8px 26px rgba(92,57,168,0.12)}
  .btn-ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--muted)}

  .small{font-size:13px;padding:8px 10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)}
  input[type="text"], textarea {
    width:100%;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);margin-top:10px;font-size:14px;background:transparent
  }
  textarea{min-height:90px}

  /* right column top controls */
  .controls{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 10px;border-radius:999px;border:1px solid rgba(15,23,42,0.04);cursor:pointer;font-weight:700;color:var(--muted)}
  .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border:none;box-shadow:0 8px 20px rgba(92,57,168,0.12)}

  .search{display:flex;gap:8px;align-items:center}
  .search input{padding:8px 10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);min-width:220px}

  /* items grid */
  #itemsGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
  .itemCard{background:white;border-radius:12px;padding:12px;border:1px solid rgba(15,23,42,0.03);box-shadow:0 8px 24px rgba(15,23,42,0.04);display:flex;flex-direction:column;gap:8px}
  .itemTop{display:flex;justify-content:space-between;align-items:center}
  .itemTitle{font-weight:800;font-size:15px}
  .pill{padding:6px 8px;border-radius:999px;font-weight:800;font-size:12px}
  .pill.lost{background:#fff3f2;color:#b42318;border:1px solid rgba(180,35,24,0.08)}
  .pill.found{background:#ecfdf5;color:#0f766e;border:1px solid rgba(15,119,110,0.06)}
  .meta{font-size:13px;color:var(--muted)}
  .actionsRow{display:flex;gap:8px;margin-top:8px}

  .contactBtn{padding:8px 10px;border-radius:10px;border:none;background:linear-gradient(90deg,#06b6d4,#0ea5a3);color:white;cursor:pointer;font-weight:700}
  .copyBtn{padding:8px 10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:transparent;cursor:pointer}

  .hidden{display:none}

  footer{max-width:1100px;margin:18px auto;color:var(--muted);font-size:13px;text-align:center}
</style>
</head>
<body>

<header>
  <h1>Lost & Found Portal</h1>
  <div style="display:flex;align-items:center;gap:14px;">
      <div class="user" id="userBadge">Not signed in</div>
      <button class="btn small" id="topSignOutBtn" style="display:none;background:white;color:var(--accent);border:1px solid rgba(255,255,255,0.5)">
        Sign out
      </button>
  </div>
</header>


<div class="main">
  <!-- LEFT: Dashboard & Form -->
  <div>
    <div class="panel" id="dashPanel">
      <h2>Quick Actions</h2>
      <p class="muted">Report an item or browse the list</p>

      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <button class="btn btn-primary" id="reportLostBtn">Report Lost Item</button>
        <button class="btn btn-primary" id="reportFoundBtn">Report Found Item</button>
        <button class="btn btn-ghost" id="viewItemsBtn">View Items</button>
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid rgba(15,23,42,0.04)">

      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn small" id="signinBtn">Sign in</button>
        <button class="btn small" id="signoutBtn" style="display:none">Sign out</button>
      </div>

      <div style="margin-top:10px;color:var(--muted);font-size:13px">
        <strong>Notes:</strong>
        <ul style="padding-left:18px;margin:8px 0 0 0">
          <li>Submissions require sign-in.</li>
          <li>Viewing items is public (no sign-in needed).</li>
        </ul>
      </div>
    </div>

    <!-- FORM panel (hidden by default) -->
    <div class="panel hidden" id="formPanel" style="margin-top:14px">
      <h2 id="formHeading">Report Item</h2>
      <div class="muted" id="formSub">Fill details and submit</div>

      <input type="text" id="inputName" placeholder="Item name (e.g. Wallet)">
      <textarea id="inputDesc" placeholder="Description: color, brand, reg-no, marks..."></textarea>
      <input type="text" id="inputLoc" placeholder="Location (e.g. SJT 103)">
      <input type="text" id="inputContact" placeholder="Contact (email or phone) — optional">

      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn btn-primary" id="submitBtn">Submit</button>
        <button class="btn btn-ghost" id="cancelFormBtn">Cancel</button>
      </div>
      <div id="formMsg" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- RIGHT: Items list -->
  <div>
    <div class="panel">
      <div class="controls">
        <div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="tabs" id="tabs">
              <div class="tab active" data-filter="all">All</div>
              <div class="tab" data-filter="lost">Lost</div>
              <div class="tab" data-filter="found">Found</div>
            </div>
          </div>
        </div>

        <div class="search">
          <input id="searchInput" placeholder="Search by name, description, location...">
          <button class="btn btn-ghost" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div id="itemsGrid"></div>
      <div id="emptyState" class="muted" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG — update only if endpoints change ================== */
const COGNITO_DOMAIN = "https://us-east-1-7mcn6ojbb.auth.us-east-1.amazoncognito.com";
const COGNITO_CLIENT_ID = "1e13f9ndiber9kat6aos0nd1ta";
// note: redirect back to the same page (implicit flow returns tokens in hash)
const REDIRECT_URI      = "https://d2iqon8l0zwmkz.cloudfront.net/portal.html";
const LOGOUT_REDIRECT_URI = "https://d2iqon8l0zwmkz.cloudfront.net/"; // portal.html
const GET_ITEMS_URL     = "https://jza9668kte.execute-api.us-east-1.amazonaws.com/prod/items";
const POST_ITEM_URL     = "https://jza9668kte.execute-api.us-east-1.amazonaws.com/prod/report";
/* ============================================================================ */

let allItems = [];
let activeFilter = "all";

/* ---------- AUTH helpers (implicit flow) ---------- */
function startSignIn(){
  // implicit login (simpler) — tokens returned in URL hash
  const url = `${COGNITO_DOMAIN}/login?response_type=token&client_id=${COGNITO_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=openid+email`;
  window.location.href = url;
}

function signOut(){
  // clear stored tokens and update UI
  localStorage.removeItem("accessToken");
  localStorage.removeItem("idToken");
  localStorage.removeItem("userEmail");
  updateAuthUI();

  // redirect to Cognito hosted login (so user can sign in again) — this also clears hosted session if needed
  const loginUrl = `${COGNITO_DOMAIN}/login?response_type=token&client_id=${COGNITO_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=openid+email`;
  window.location.href = loginUrl;
}

function parseHashTokens(){
  if(!window.location.hash) return;
  const params = new URLSearchParams(window.location.hash.slice(1));
  const accessToken = params.get("access_token");
  const idToken = params.get("id_token");
  if(accessToken){
    localStorage.setItem("accessToken", accessToken);
  }
  if(idToken){
    localStorage.setItem("idToken", idToken);
    try{
      const payload = JSON.parse(atob(idToken.split('.')[1]));
      if(payload && payload.email) localStorage.setItem("userEmail", payload.email);
    }catch(e){ /* ignore decode errors */ }
  }
  // remove hash for cleanliness
  history.replaceState(null, '', window.location.pathname + window.location.search);
}

function updateAuthUI(){
  const token = localStorage.getItem("accessToken");
  const email = localStorage.getItem("userEmail");
  const badge = document.getElementById("userBadge");
  const topSignOut = document.getElementById("topSignOutBtn");
  if(token){
    badge.textContent = email ? `Signed in as ${email}` : "Signed in";
    document.getElementById("signinBtn").style.display = "none";
    document.getElementById("signoutBtn").style.display = "inline-flex";
    topSignOut.style.display = "inline-flex";
    topSignOut.addEventListener('click', signOut);
  } else {
    badge.textContent = "Not signed in";
    document.getElementById("signinBtn").style.display = "inline-flex";
    document.getElementById("signoutBtn").style.display = "none";
    topSignOut.style.display = "none";
  }
}

/* ---------- utility & parsing ---------- */
function getField(item, names){
  for(const n of names){
    if(item[n] !== undefined && item[n] !== null && String(item[n]).trim() !== "") return item[n];
  }
  return undefined;
}
function parseItem(item){
  // normalize type to lowercase 'lost' or 'found'
  const type = (getField(item, ["type","status","itemType"]) || "unknown").toString().toLowerCase();
  const name = getField(item, ["itemName","item_name","name","title"]) || "Unnamed item";
  const description = getField(item, ["description","desc","details","notes"]) || "";
  const location = getField(item, ["location","place","where","loc"]) || "—";
  const contact = getField(item, ["contact","contactInfo","phone","email"]) || "";
  const ts = getField(item, ["timestamp","time","created_at","createdAt"]);
  let when = "—";
  if(ts){
    const d = new Date(ts);
    if(!isNaN(d)) when = d.toLocaleString();
    else {
      const n = Number(ts);
      if(!isNaN(n)) when = new Date(n).toLocaleString();
    }
  }
  const id = getField(item, ["itemId","id","uuid","pk"]) || "";
  return { raw:item, type, name, description, location, contact, when, id };
}

/* ---------- render ---------- */
function escapeHtml(s){ if(s===undefined||s===null) return ""; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeAttr(s){ return String(s).replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase() + s.slice(1); }

function renderItems(list){
  const grid = document.getElementById("itemsGrid");
  grid.innerHTML = "";
  if(!list || list.length === 0){
    document.getElementById("emptyState").textContent = "No items found.";
    return;
  } else {
    document.getElementById("emptyState").textContent = "";
  }

  for(const it of list){
    const p = parseItem(it);
    const card = document.createElement("div");
    card.className = "itemCard";

    const pillClass = p.type.includes("lost") ? "pill lost" : "pill found";
    card.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(p.description)}</div>
        </div>
        <div>
          <div class="${pillClass}">${capitalize(p.type)}</div>
        </div>
      </div>

      <div class="meta"><strong>Location:</strong> ${escapeHtml(p.location)}</div>
      <div class="meta"><strong>When:</strong> ${escapeHtml(p.when)}</div>
      <div class="actionsRow">
        ${p.contact ? `<button class="contactBtn" data-contact="${escapeAttr(p.contact)}">Contact</button>` : `<button class="copyBtn" disabled>Contact not provided</button>`}
        <button class="copyBtn" data-id="${escapeAttr(p.id)}">Copy ID</button>
      </div>
    `;

    grid.appendChild(card);
  }

  document.querySelectorAll('.contactBtn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const contact = btn.getAttribute('data-contact') || "";
      contactAction(contact);
    });
  });
  document.querySelectorAll('.copyBtn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const id = btn.getAttribute('data-id') || "";
      if(!id) return;
      try{
        await navigator.clipboard.writeText(id);
        alert('Item ID copied to clipboard');
      }catch(err){
        alert('Copy failed: ' + err);
      }
    });
  });
}

/* ---------- contact ---------- */
function contactAction(contact){
  contact = contact.trim();
  if(contact.includes('@')){
    window.location.href = `mailto:${encodeURIComponent(contact)}?subject=${encodeURIComponent('Regarding your Lost/Found report')}`;
  } else {
    navigator.clipboard.writeText(contact).then(()=> alert('Contact copied to clipboard: ' + contact), ()=> alert('Could not copy contact.'));
  }
}

/* ---------- API calls ---------- */
async function fetchItemsFromApi(){
  try{
    document.getElementById('itemsGrid').innerHTML = `<div class="muted">Loading...</div>`;
    const res = await fetch(GET_ITEMS_URL);
    if(!res.ok) throw new Error('Failed to fetch items (status ' + res.status + ')');
    const data = await res.json();
    allItems = Array.isArray(data) ? data : (data.Items || data.items || []);
    applyFilters();
  }catch(err){
    console.error(err);
    document.getElementById('itemsGrid').innerHTML = `<div class="muted">Error loading items.</div>`;
  }
}

function applyFilters(){
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  let filtered = allItems.slice();

  if(activeFilter !== 'all'){
    filtered = filtered.filter(it => {
      const t = (getField(it, ['type','status','itemType']) || '').toString().toLowerCase();
      return t.includes(activeFilter);
    });
  }

  if(q){
    filtered = filtered.filter(it => {
      const p = parseItem(it);
      const hay = (p.name + ' ' + p.description + ' ' + p.location).toLowerCase();
      return hay.includes(q);
    });
  }

  renderItems(filtered);
}

async function submitItem(){
  const name = document.getElementById('inputName').value.trim();
  const desc = document.getElementById('inputDesc').value.trim();
  const loc  = document.getElementById('inputLoc').value.trim();
  const contact = document.getElementById('inputContact').value.trim();

  const token = localStorage.getItem('accessToken');
  const msg = document.getElementById('formMsg');

  if(!token){
    msg.textContent = "You must sign in to submit.";
    return;
  }
  if(!name || !desc || !loc){
    msg.textContent = "Please fill name, description and location.";
    return;
  }
  msg.textContent = "Submitting...";

  const payload = {
    type: (window._reportType || 'lost').toString().toLowerCase(),
    itemName: name,
    description: desc,
    location: loc,
    contact: contact,
    timestamp: new Date().toISOString()
  };

  try{
    const res = await fetch(POST_ITEM_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify(payload)
    });
    if(res.ok){
      msg.style.color = 'green';
      msg.textContent = "Saved successfully ✅";
      document.getElementById('inputName').value = '';
      document.getElementById('inputDesc').value = '';
      document.getElementById('inputLoc').value = '';
      document.getElementById('inputContact').value = '';
      await fetchItemsFromApi();
      setTimeout(()=>{ showPanel('dash'); msg.textContent = ''; msg.style.color=''; }, 700);
    } else {
      const txt = await res.text();
      msg.style.color = 'crimson';
      msg.textContent = 'Submit failed: ' + txt;
    }
  }catch(e){
    console.error(e);
    msg.style.color = 'crimson';
    msg.textContent = 'Network error';
  }
}

/* ---------- UI control ---------- */
function showPanel(which){
  document.getElementById('dashPanel').classList.toggle('hidden', which !== 'dash');
  document.getElementById('formPanel').classList.toggle('hidden', which !== 'form');
  // show/hide right column (items) when dash visible
  const itemsPanel = document.getElementById('itemsGrid').parentElement.parentElement;
  itemsPanel.classList.toggle('hidden', which === 'dash');
  if(which === 'items') fetchItemsFromApi();
}

function openFormWithType(type){
  window._reportType = type;
  document.getElementById('formHeading').textContent = type === 'lost' ? 'Report Lost Item' : 'Report Found Item';
  document.getElementById('formSub').textContent = 'Please provide a clear description and contact details.';
  document.getElementById('formMsg').textContent = '';
  showPanel('form');
}

/* ---------- events ---------- */
document.getElementById('reportLostBtn').addEventListener('click', ()=> openFormWithType('lost'));
document.getElementById('reportFoundBtn').addEventListener('click', ()=> openFormWithType('found'));
document.getElementById('viewItemsBtn').addEventListener('click', ()=> { activeFilter='all'; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelector('.tab[data-filter="all"]').classList.add('active'); showPanel('items'); });
document.getElementById('signinBtn').addEventListener('click', startSignIn);
document.getElementById('signoutBtn').addEventListener('click', signOut);
document.getElementById('cancelFormBtn').addEventListener('click', ()=> showPanel('dash'));
document.getElementById('submitBtn').addEventListener('click', submitItem);
document.getElementById('refreshBtn').addEventListener('click', fetchItemsFromApi);
document.getElementById('searchInput').addEventListener('input', ()=> applyFilters());
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', (e)=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    e.target.classList.add('active');
    activeFilter = e.target.getAttribute('data-filter');
    applyFilters();
  });
});

/* ---------- init ---------- */
(function init(){
  parseHashTokens();
  updateAuthUI();
  // initial items load (public)
  fetchItemsFromApi();
})();
</script>
</body>
</html>
